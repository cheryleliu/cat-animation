<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MusePiece Â· Cat Demo</title>
  <style>
    /* ====== å…¨å±€ä¸èˆå° ====== */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: #0b0b0b; color: #111;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .page { height: 100dvh; width: 100vw; display: grid; place-items: center; }
    .stage {
      position: relative;
      aspect-ratio: 9 / 16;
      width: min(100vw, 56.25vh);
      background: #000;
      overflow: hidden;           /* å¿…é¡»ï¼Œé¿å…æ”¾å¤§åéœ²è¾¹ */
      border-radius: 16px;
    }

    /* ====== è§†é¢‘å›¾å±‚ï¼ˆè§£å†³â€œå°¾å·´é è¾¹å˜ç»†â€ï¼‰ ====== */
    :root{
      --video-scale: 1.02;   /* è½»å¾®æ”¾å¤§ 2% ä½œä¸ºå®‰å…¨è¾¹è·ï¼Œå¿…è¦æ—¶ä½ å¯æ”¹ 1.03 */
      --video-pos-x: 50%;    /* å–æ™¯å·¦å³ï¼š40% åå·¦ / 60% åå³ */
      --video-pos-y: 52%;    /* å–æ™¯ä¸Šä¸‹ï¼š45% åä¸Š / 60% åä¸‹ï¼›é»˜è®¤ç•¥æŠ¬é«˜ï¼Œé¿å¼€åº•è¾¹ */
    }
    .video-layer { position: absolute; inset: 0; overflow: hidden; }
    video{
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      object-position: var(--video-pos-x) var(--video-pos-y);
      transform: scale(var(--video-scale)) translateZ(0);  /* GPU & æŠ—é‡‡æ · */
      transform-origin: center center;
      background: #000;
    }

    /* ====== å åŠ å±‚ï¼ˆæ°”æ³¡ + è¾“å…¥ï¼‰ ====== */
    .overlay { position: absolute; inset: 0; pointer-events: none; }

    /* è§„åˆ™æ°”æ³¡ï¼ˆçŸ©å½¢/åœ†è§’ï¼‰ï¼Œä¼˜å…ˆç”¨ cat_bubble.png */
    .bubble{
      /* å°ºå¯¸ä¸ä½ç½®ï¼ˆå¯æŒ‰éœ€å¾®è°ƒï¼‰ */
      --bubble-width: 86%;
      --bubble-aspect: 1.70;   /* å®½:é«˜ é»˜è®¤ 1.70ï¼›JS ä¼šç”¨å›¾ç‰‡çœŸå®æ¯”ä¾‹è‡ªåŠ¨è¦†ç›– */
      --bubble-top: 7%;
      --bubble-left: 50%;

      position: absolute;
      left: var(--bubble-left);
      top: var(--bubble-top);
      width: var(--bubble-width);
      height: calc(var(--bubble-width) / var(--bubble-aspect));
      transform: translateX(-50%);

      /* PNG åœ¨ä¸Šï¼Œé€æ˜å¤„é€å‡ºæµ…ç»¿æ¸å˜ï¼›æ²¡å›¾æ—¶æ˜¾ç¤ºæ¸å˜å…œåº• */
      background:
        url("cat_bubble.png") center / contain no-repeat,
        linear-gradient(180deg,#eaf7f0,#f6faf7);
      border-radius: 24px;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.22));
      pointer-events: none;
    }
    .bubble__text{
      /* æ°”æ³¡å†…çš„å®‰å…¨åŒºï¼ˆè§„åˆ™æ°”æ³¡å¯ç”¨è¾ƒç´§çš„è¾¹è·ï¼‰ */
      --padX: 8%;
      --padTop: 12%;
      --padBottom: 14%;

      position: absolute;
      left: var(--padX); right: var(--padX);
      top: var(--padTop); bottom: var(--padBottom);

      overflow: hidden;
      word-break: break-word; hyphens: auto;
      text-align: center;
      color: #1a1a1a;
      line-height: 1.35;
      font-size: 26px; /* åˆå§‹å€¼ï¼ŒJS ä¼šæŒ‰éœ€ç¼©æ”¾ */
    }

    /* è¾“å…¥æ¡†åŒºåŸŸï¼ˆä¼˜å…ˆç”¨ input_box.pngï¼›è‡ªåŠ¨è¯»å–å›¾ç‰‡æ¯”ä¾‹ï¼‰ */
    .composer{
      --composer-width: 92%;
      --composer-aspect: 7.5;      /* JS ä¼šç”¨ PNG å®é™…æ¯”ä¾‹è¦†ç›– */
      --composer-bottom: 3.6%;
      position: absolute;
      left: 50%; bottom: var(--composer-bottom);
      width: var(--composer-width);
      height: calc(var(--composer-width) / var(--composer-aspect));
      transform: translateX(-50%);

      background-image: url("input_box.png"), linear-gradient(180deg,#ffffff,#f3f7f5);
      background-position: center, center;
      background-repeat: no-repeat, no-repeat;
      background-size: 100% 100%, cover;  /* è®© PNG å®Œå…¨å¡«å……è¯¥æ¡† */

      border-radius: 18px;
      box-shadow: 0 8px 22px rgba(0,0,0,.22);
      border: 1px solid rgba(0,0,0,.06);

      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 0 clamp(12px, 2.2%, 16px);
      gap: clamp(8px, 1.8vw, 12px);
      pointer-events: auto; z-index: 10;
    }
    .composer input[type="text"]{
      width: 100%; border: none; outline: none; background: transparent;
      font-size: 18px; line-height: 1.2; color: #1a1a1a;
    }
    .composer input::placeholder{ color:#6b7280; opacity:.9; }
    .btn{
      border: none; outline: none; border-radius: 14px;
      padding: 10px 14px; font-size: 16px;
      background:#111827; color:#fff; cursor:pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.25);
    }

    /* iOS è‡ªåŠ¨æ’­æ”¾é—¨ç¦ */
    .gate{ position:absolute; inset:0; display:grid; place-items:center;
           background: rgba(0,0,0,.5); color:#fff; pointer-events:auto; }
    .gate[hidden]{ display:none; }
    .gate .bubble-card{
      background: rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 16px; padding: 14px 16px; max-width: 80%;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="page">
    <main class="stage" id="stage">
      <!-- è§†é¢‘å±‚ï¼šä¸€æ¬¡æ€§å¼€åœº + å¾ªç¯ -->
      <div class="video-layer">
        <video id="vidIntro" playsinline muted preload="auto">
          <source src="cat-yawn-blink.mp4" type="video/mp4" />
        </video>
        <video id="vidLoop" playsinline muted preload="auto" loop hidden>
          <source src="cat-blink-loop.mp4" type="video/mp4" />
        </video>
      </div>

      <!-- å åŠ å±‚ï¼šè§„åˆ™æ°”æ³¡ + è¾“å…¥æ¡† + é—¨ç¦ -->
      <div class="overlay">
        <section class="bubble" aria-live="polite" aria-atomic="true">
          <div class="bubble__text" id="bubbleText">Mew~ Been waiting for you.</div>
        </section>

        <form class="composer" id="composer" autocomplete="off">
          <input id="userInput" type="text" name="q" placeholder="Type what youâ€™re feelingâ€¦" maxlength="280" />
          <button class="btn" id="sendBtn" type="submit">Send</button>
        </form>

        <div class="gate" id="gate">
          <div class="bubble-card">
            <div style="font-weight:600; font-size: 16px; margin-bottom: 6px;">Tap to enter</div>
            <div style="opacity:.9; font-size: 14px;">If video doesnâ€™t start automatically, tap anywhere to begin. ğŸ¾</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const $ = (s, r=document)=>r.querySelector(s);
    const vidIntro   = $('#vidIntro');
    const vidLoop    = $('#vidLoop');
    const gate       = $('#gate');
    const bubbleText = $('#bubbleText');
    const input      = $('#userInput');
    const form       = $('#composer');

    // è‡ªåŠ¨æ’­æ”¾ï¼ˆå¤±è´¥åˆ™æ˜¾ç¤ºé—¨ç¦ï¼‰
    async function startPlayback(){
      try{ await vidIntro.play(); gate.hidden = true; }
      catch{ gate.hidden = false; }
    }
    function swapToLoop(){
      vidIntro.hidden = true;
      vidLoop.hidden  = false;
      vidLoop.currentTime = 0;
      vidLoop.play().catch(()=>{});
    }

    // æ–‡æ¡ˆè‡ªåŠ¨ç¼©æ”¾ï¼šé•¿å¥ä¸å‡ºæ¡†ï¼ŒçŸ­å¥æ›´å¤§
    function fitText(el, {min=14, max=30}={}){
      const box = el.parentElement; // .bubble__text çš„å®¹å™¨
      let size = max;
      el.style.fontSize = size + 'px';
      // é€çº§å‡å°ç›´åˆ°å®Œå…¨è£…å…¥
      while (size > min && el.scrollHeight > box.clientHeight){
        size -= 1; el.style.fontSize = size + 'px';
      }
    }

    // è¯»å– PNG å®é™…æ¯”ä¾‹ï¼Œè‡ªåŠ¨è®¾ç½® --bubble-aspect / --composer-aspect
    function autoAspect(varName, src){
      const img = new Image();
      img.onload = () => {
        if (img.naturalWidth && img.naturalHeight){
          const aspect = img.naturalWidth / img.naturalHeight;
          document.documentElement.style.setProperty(varName, aspect);
        }
      };
      img.src = src;
    }

    (function init(){
      // è§†é¢‘åˆ‡æ¢ & é—¨ç¦
      vidIntro.addEventListener('error', swapToLoop);
      vidIntro.addEventListener('ended', swapToLoop);
      if (document.visibilityState === 'visible') startPlayback();
      document.addEventListener('visibilitychange', ()=> {
        if (document.visibilityState === 'visible' && gate.hidden === false) startPlayback();
      });
      gate.addEventListener('click', startPlayback, { passive: true });

      // åˆå§‹è‡ªé€‚åº”
      fitText(bubbleText, {min:14, max:30});
      autoAspect('--bubble-aspect',  'cat_bubble.png');
      autoAspect('--composer-aspect','input_box.png');

      // æç®€â€œå•æ°”æ³¡è½®æµâ€å‡å›å¤ï¼ˆå ä½ï¼šåç»­æ¢ä¸º APIï¼‰
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const text = (input.value || '').trim();
        if(!text) return;
        bubbleText.textContent = text;
        fitText(bubbleText, {min:14, max:30});
        input.value = '';

        setTimeout(()=>{
          const replies = [
            'Got it. Iâ€™m here. Want to tell me a bit more?',
            'Iâ€™m listening. What feeling is strongest right now?',
            'Letâ€™s breathe together for 3 secondsâ€¦ and then keep going.'
          ];
          bubbleText.textContent = replies[Math.floor(Math.random()*replies.length)];
          fitText(bubbleText, {min:14, max:30});
        }, 900);
      });
    })();
  </script>
</body>
</html>
